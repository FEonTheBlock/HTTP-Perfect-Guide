# 5장 웹서버

## 다채로운 웹 서버

> 웹 서버는 HTTP 요청을 처리하고 응답을 제공한다.
> <br>웹 서버란 웹 서버 소프트웨어, 웹 페이지 제공에 특화된 장비 모두를 가리킨다.

### 웹 서버 구현

> 웹 서버란 HTTP 및 이와 관련된 TCP 처리를 구현한 것

**웹 서버의 형태**

- 다목적 소프트웨어
- 마이크로프로세서

### 다목적 소프트웨어 웹 서버

> 주로 몇가지 웹 서버 소프트 웨어만이 널리 사용됨

- MS 웹 서버: 모든 인터넷의 37%
- 아파치 웹 서버: 35%
- nginx 서버: 14%

-> 최근 2022년도에는 아파치가 40%, nginx가 27%로 높은 점유율을 달리고 있다.

### 임베디드 웹 서버

- 일반 소비자용 제품에 내장될 목적으로 만들어진 작은 웹 서버
- 간편한 웹 브라우저 인터페이스로 관리할 수 있게 해줌

## 간단한 펄 웹 서버

일반적인 `HTTP/1.1`의 기능들을 지원하기 위해서는 풍부한 리소스 자원, 가상 호스팅, 접근 제어, 로깅, 설정, 모니터링 등 성능을 위한 각종 기능들이 필요하다.

대신 최소한으로 동작하는 HTTP서버는 30줄 이하의 펄 코드로도 만들 수 있다.

## 진짜 웹 서버가 하는 일

**공통적으로 아래와 같은 일을 수행한다.**

1. 커넥션을 맺는다
2. 요청을 받는다
3. 요청을 처리한다
4. 리소스에 접근한다
5. 응답을 만들다
6. 응답을 보낸다
7. 트랜잭션을 로그로 남긴다

## 1 | 클라이언트 커넥션 수락

> 클라이언트가 이미 서버에 열려있는 지속 커넥션이 있으면 해당 커넥션을 사용하고, 없다면 새로운 커넥션을 연다.

### 새로운 커넥션 다루기

- 서버는 클라이언트와 커넥션을 맺고 그 커넥션에서 IP주소를 추출하여 어떤 클라이언트인지 확인한다.
- 이후 새로운 커넥션을 커넥션 목록에 추가하고 어떤 데이터들이 오가는지 지켜보기 위한 준비를 한다.
- 이 과정에서 IP주소나 호스트명이 인가되지 않았거나 악의적이라고 알려진 것인 경우 커넥션을 닫는다.

### 클라이언트 호스트명 식별

> 웹 서버는 역방향 DNS를 사용해서 클라이언트의 IP 주소로부터 호스트 명을 변환하여 이를 구체적인 접근 제어와 로깅을 위해 사용할 수 있다.
> <br>이러한 호스트명 룩업은 웹 트랙잭션을 느려지게 할 수 있으므로 대부분의 웹 서버에서는 이를 꺼두거나 특정 콘텐츠에 대해서만 켜둔다.

### ident를 통해 클라이언트 사용자 알아내기

> ident 프로토콜은 서버에게 어떤 사용자 이름이 HTTP 커넥션을 초기화했는지 찾아낼 수 있게 해준다.

- 일반적으로 113번 포트를 사용한다.
- 보안 상 문제로 공공 인터넷에서는 잘 동작하지 않는다.

## 2 | 요청 메세지 수신

> 요청 메세지 파싱 시 요청 메서드, URI, 버전 번호를 찾고, CRLF를 기준으로 읽는다

### 메세지의 내부 표현

특정 웹 서버는 요청 메세지를 쉽게 다룰 수 있도록 내부 자료구조에 저장하여 관리한다.

## 3 | 요청 처리

> HTTP메서드에 따라 요청을 처리

## 4 | 리소스의 매핑과 접근

> 요청 메세지의 URI에 대응하는 콘텐츠를 식별하는 과정

### Docroot

웹 서버 파일 시스템의 특별한 폴더이며, 웹 콘텐츠를 위해 예약해 둔 것

### 디렉터리 목록

> 모든 파일의 이름을 우선순위로 나열해주는 디렉터리 색인 파일 자동 생성 기능도 있고 웹 서버에서 이를 끄고 켤 수 있다.

파일이 아닌 디렉터리 URL에 대한 요청을 받을 때 아래와 같은 행동을 취하도록 웹 서버를 설정할 수 있다.

- 에러 반환
- 디렉터리 대신 특별한 색인 파일 반환
- 디렉터리를 탐색해서 그 내용을 담은 HTML 페이지를 반환

### 동적 콘텐츠 리소스 매핑

오늘날의 애플리케이션 서버는 서버사이드 동적 콘텐츠 지원기능을 갖고 있다.

### 서버사이드 인클루드

> 동적 콘텐츠를 만드는 쉬운 방법

이 설정이 되어 있다면 서버는 해당 리소스의 콘텐츠를 클라이언트에게 보내기 전에 처리한다.

### 접근 제어

웹 서버는 클라이언트의 IP 주소에 근거하거나 비밀번호를 요구하여 각각의 리소스에 접근 제어를 할당할 수 있다.

## 5 | 응답 만들기

> 응답 메세지는 응답 상태코드, 응답 헤더, 응답 본문을 포함한다.

### 응답 본문

- 응답 본문의 `MIME` 타입을 서술하는 `Content-Type` 헤더
- 응답 본문의 길이를 서술하는 `Content-Length` 헤더
- 실제 응답 본문의 내용

### MIME 타입 결정하기

- `mime.types`: 웹 서버는 각 리소스의 `MIME` 타입 계싼을 위한 확장자별 `MIME` 타입이 담겨있는 파일을 탐색한다.
- 매직 타이핑: 파일 내용 검사 후 알려진 패턴에 대한 테이블에 해당하는 패턴을 찾는다.
- 유형 명시: 파일 확장자나 내용에 상관없이 어떤 `MIME`타입을 갖도록 웹 서버를 설정하는 것
- 유형 협상: 한 리소스가 여러 종류의 문서 형식에 속하도록 결정
  - 이 과정을 통해 사용하기 좋은 형식을 판별할 것인지 여부도 설정 가능

### 리다이렉션

> 웹 서버는 요청을 수행하기 위해 브라우저가 다른 곳으로 가도록 리다이렉트 할 수 있다.

- 301: 영구히 리소스가 옮겨진 경우
- 303: 임시로 리소스가 옮겨진 경우

## 6 | 응답 보내기

> 서버는 커넥션 상태를 추적하여 비지속적인 커넥션이면 메세지 전송 후 커넥션을 닫는다.

## 7 | 로깅

> 트랜잭션이 완료되면 로그를 로그 파일에 기록한다.
