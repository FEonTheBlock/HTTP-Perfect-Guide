# 20220409 7장 캐시

캐시는 불필요한 데이터 전송, 네트워크 병목, 원 서버에 대한 요청, 거리로 인한 지연을 줄여준다. 캐시가 어떻게 성능을 개선하고 비용을 줄이는지, 어디에 위치시켜 효과를 극대화할 수 있는지, HTTP가 어떻게 캐시된 사본을 신선하게 유지하며, 캐시가 다른 캐시나 서버와 어떻게 상호작용하는지 알아보자.

## 7.1 불필요한 데이터 전송

같은 데이터를 클라이언트에게 한 번씩 각각 전송한다면 네트워크 대역폭을 잡아먹고, 전송을 느리게 만들며, 웹 서버에 부하를 준다. 

→ 첫 번째 서버 응답을 캐시에 보관하고 뒤이은 요청들에 대한 응답으로 보관된 사본을 사용하여 낭비를 줄인다.

## 7.2 대역폭 병목

원격 서버보다 로컬 네트워크 클라이언트에 더 넓은 대역폭이 제공되므로 빠른 LAN에 있는 캐시로부터 사본을 가져와 전송 시간을 줄일 수 있다.

## 7.3 갑작스런 요청 쇄도 (Flash Crowds)

많은 사람이 동시에 웹 문서에 접근할 때 일어나는 갑작스런 요청 쇄도에 대처하기 위해 캐시는 중요하다. 

불필요한 트래픽 급증으로 네트워크와 웹 서버에 장애를 야기시키는 상황을 방지할 수 있다.

## 7.4 거리로 인한 지연

라우터를 거칠 때마다 인터넷 트래픽 지연, 물리적 거리로 인한 지연 발생하므로 캐시를 통해 문서가 전송되는 거리를 줄일 수 있다.

## 7.5 적중과 부적중

- 적중(Cache Hit): 캐시에 요청이 도청했을 때 그에 대응하는 사본이 있어 이를 이용해 요청을 처리하는 경우
- 부적중(Cache Miss): 대응하는 사본이 없어 원 서버로 요청이 전달되는 경우

### 7.5.1 재검사(Revalidate)

- HTTP 재검사: 캐시가 가진 사본이 여전히 최신인지 서버를 통해 점검하는 신선도 검사
- 클라이언트가 사본을 요청했으며, 그 사본이 검사를 할 필요가 있을 정도로 오래된 경우 수행
- 캐시된 객체를 재확인하기 위해 If-Modified-Since 헤더 등 캐시 사본을 재확인하기 위한 도구를 제공 → 이를 헤더에 가진 GET 요청이 서버에 도착한 후의 세 가지 시나리오
    - 재검사 적중(느린 적중): 콘텐츠가 변경되지 않아 서버가 `304 Not Modified` 응답 반환 
    → 캐시는 사본이 신선하다는 것을 표시 후 클라이언트에 제공
    - 재검사 부적중: 서버 객체가 캐시된 사본과 달라 콘텐츠 전체와 함께 `200 OK` 응답 반환
    - 객체 삭제: 서버 객체가 삭제되어 `404 Not Found` 으로 응답하고, 캐시는 사본을 삭제

### 7.5.2 적중률

- 캐시 적중률(문서 적중률): 캐시가 요청을 처리하는 비율
- 얼마나 많은 웹 트랜잭션을 외부로 내보내지 않았는지 보여주며, 전체 대기시간(지연)의 절약 최적화

### 7.5.3 바이트 적중률

- 문서의 크기가 상이하므로 문서 적중률이 높다고 항상 더 성능이 좋은 것은 아님
- 캐시를 통해 제공된 모든 바이트의 비율인 바이트 단위 적중률 측정값을 통해 캐시 성능 파악 가능
- 얼마나 많은 바이트가 인터넷으로 나가지 않았는지 보여주며, 대역폭 절약 최적화

### 7.5.4 적중과 부적중의 구별

- 응답 코드는 모두 `200 OK`이므로, 캐시 적중으로 제공된 사본인지 원 서버로부터 받은 응답인지 클라이언트는 알 수 없음
- 캐시에서 `Via` 헤더에 추가 정보를 붙이거나, `Date` 헤더, `Age` 헤더를 확인하면 응답이 캐시된 것인지 추정할 수 있음

## 7.6 캐시 토폴로지

### 7.6.1 개인 전용 캐시(Private Cache)

- 한 명의 사용자가 자주 찾는 페이지를 캐싱
- 작고 저렴
- 웹브라우저는 개인 전용 캐시를 내장하여 개인용 컴퓨터의 디스크나 메모리에 자주 쓰이는 문서를 캐시

### 7.6.2 공용 프락시 캐시(Public Cache)

- 사용자 집단에게 자주 쓰이는 페이지를 캐싱
- 공유된 프락시 서버(캐시 프락시 서버 또는 프락시 캐시라고 불림)
- 로컬 캐시에서 문서를 제공 또는 사용자의 입장에서 서버에 접근
- 여러 사용자가 접근하므로 불필요한 트래픽을 줄일 수 있는 더 많은 기회 
→ 모든 요청에 한 번 가져온 공유된 사본을 제공하여 네트워크 트래픽을 줄임

### 7.6.3 프락시 캐시 계층들

- 클라이언트 주위에 작고 저렴한 캐시, 계층 상단에 더 크고 강력한, 많은 사용자들을 위한 캐시
- 가까운 캐시에서 적중하지 않은 요청이 부모 캐시에게 접근

### 7.6.4 캐시망, 콘텐츠 라우팅, 피어링

- 단순한 캐시 계층 대신 복잡한 캐시망을 통해 서로 대화하며 커뮤니케이션 결정을 동적으로 내림
- 서로 다른 조직들이 캐시를 연결하여 서로 찾아보도록 선택적 피어링을 지원하는 형제 캐시

## 7.7 캐시 처리 단계

## 7.8 사본을 신선하게 유지하기

## 7.9 캐시 제어

- 문서 만료되기 전까지 얼마나 오래 캐시될지 서버에서 설정하는 방법들
    - 응답에 `Cache-control: no-store`, `Cache-control: no-cache`, `Cache-control: must-revalidate`, `Cache-control: max-age`, `Expires` 날짜 등의 헤더를 첨부
- 만료 정보 없이, 캐시가 스스로 체험적인 방법으로 결정

### 7.9.1 `no-cache`, `no-store` 응답 헤더

- 캐시가 검증되지 않은 캐시된 객체로 응답하는 것을 막는다.
- `no-store`: 캐시가 해당 응답의 사본을 만드는 것을 금지하며 이 응답을 받은 캐시는 클라이언트에게 응답을 전달한 후 객체를 삭제
- `no-cache`: 로컬 캐시 저장소에 저장될 수는 있지만 서버 재검사 없이 클라이언트로 제공될 수 없음
- `Pragma: no-cache`: HTTP/1.0+ 하위호환을 위한 경우 사용하는 헤더

### 7.9.2 `Max-Age` 응답 헤더

- `Cache-control: max-age`: 신선하다고 간주된 문서가 서버로부터 온 이후로 흐른 시간을 초로 표현
- 0으로 설정하면 매 접근마다 문서를 캐시하거나 리프레시하지 않도록 요청

### 7.9.3 `Expires` 응답 헤더 (deprecated)

- 초 단위의 시간 대신 실제 만료 날짜 명시
- 절대시각보다 경과된 시간으로 표현하는 것이 낫다고 판단하여 현재는 사용 X
- 문서를 항상 만료되도록 0 값을 넣어 응답하는 것은 문법 위반

### 7.9.4 `Must-Revalidate` 응답 헤더

- 캐시는 성능개선을 위해 만료된 객체를 제공하도록 설정할 수도 있음
- `must-revalidate`: 만료 정보를 엄격히 따르게, 즉 이 객체의 신선하지 않은 (만료된) 사본을 재검사 없이 제공하지 못하게 함
- 신선도 검사 시 서버가 사용 불가인 경우 캐시는 `504 Gateway Timeout error` 반환

### 7.9.5 휴리스틱 만료

- 응답이 `Cache-control: max-age`나 `Expires` 중 어느 것도 포함하지 않으면 캐시는 경험적인 방법(heuristic)으로 최대 나이를 계산
- 계산 결과로 얻은 최대 나이가 24시간보다 크면 Heuristic Expiration 경고 헤더가 응답 헤더에 추가
- 문서가 최근 변경 일시를 포함하고 있다면 이를 활용하여 캐시의 신선도 지속기간을 결정
    - LM 인자 알고리즘을 통해 문서가 얼마나 자주 바뀌는지 추정하여 신선도 유지 기간 산정
    - 휴리스틱 신선도 유지 기간에 상한을 설정(하루~1주일)하여 지나치게 커지는 것을 방지
- 문서에 최근 변경일이 없다면 휴리스틱 계산의 근거가 없으므로 기본 신선도 유지기간을 설정 (1시간~하루)
    - 0의 신선도 수명을 설정하면 매번 신선도를 검사하도록 강제

### 7.9.6 클라이언트 신선도 제약

- 웹브라우저는 콘텐츠를 강제로 갱신(리프레시나 리로드 버튼)
    - `Cache-control` 요청 헤더가 추가된 GET 요청을 발생시켜 강제 재검사 또는 서버로부터 콘텐츠를 무조건 받아온다.
- 클라이언트는 `Cache-Control` 요청 헤더를 사용하여 만료 제약을 제어할 수 있다.

### 7.9.7 주의할 점

- 문서 만료는 완벽한 시스템이 아님
- 유효기간을 길게 잡지 않거나 사용조차 하지 않는 경우도 있음

## 7.10 캐시 제어 설정