# 17장 | 내용 협상과 트랜스코딩

## 내용 협상 기법

> 서버에 있는 페이지 중 어떤 페이지가 클라이언트에게 부합하는지 판단하는 3가지 방법

- 클라이언트 주도 협상: 클라이언트에게 선택지를 주는 방법
- 서버 주도 협상: 서버가 자동으로 판단하는 방법
- 투명 협상: 프락시가 선택하도록 부탁하는 방법

## 클라이언트 주도 협상

> 클라이언트가 요청을 보내면 서버가 클라이언트에게 선택지를 보내주고 클라이언트가 선택하도록 하는 방법이다.

### 장점

서버 입장에서 가장 구현하기 쉽고 최선의 사본을 선택할 수 있음

### 단점

목록과 선택된 사본 두번의 요청이 필요하다.

## 서버 주도 협상

> 서버가 클라이언트의 요청 헤더를 검증해서 어떤 버전을 제공할지 결정한다.

### 장점

클라이언트 주도 협상보다 빠르다.

### 단점

어떤 버전을 제공할지 판단하기 위한 헤더의 정보가 부족하다면 서버는 추측해야한다.

### 내용 협상 헤더

| 헤더 | 설명 |
| Accept | 서버가 어떤 미디어 타입으로 보내도 되는지 알려준다. |
| Accept-Language | 서버가 어떤 언어로 보내도 되는지 알려준다. |
| Accept-Charset | 서버가 어떤 차셋으로 보내도 되는지 알려준다. |
| Accept-Encoding | 서버가 어떤 인코딩으로 보내도 되는지 알려준다. |

### 내용 협상 헤더의 품질값

> 클라이언트가 각 선호의 카테고리마다 여러 선택 가능한 항목을 선호도와 함께 나열할 수 있도록 품질값을 정의하였다.

```shell
Accept-Language: en;q=0.5, fr:q=0.0, nl;q=1.0, tr;q=0.0
```

이를 통해 선호하는 문서를 판별하여 보내주고, 그러한 문서를 가지고 있지 않다면 서버는 클라이언트의 선호에 맞추기 위해 문서를 고치거나 트랜스코딩할 수 있다.

### 그 외의 헤더들에 의해 결정

> 서버는 또한 `User-Agent`와 같은 클라이언트의 다른 요청 헤더들을 이용해 알맞은 요청을 만들어내려고 시도할 수 있다.

캐시에서는 `Vary`헤더를 통해 서버가 응답할 최선의 버전을 결정하기 위해 어떤 요청 헤더를 참고하고 있는지 말해준다.

## 투명 협상

> 클라이언트 입장에서 협상하는 중개자 프락시를 둠으로써 투명한 중간 장치(주로 프락시 캐시)가 서버를 대신하여 협상을 한다.
> <br>`Vary` 헤더를 통해 서버는 클라이언트의 요청중 어떤 헤더를 검사해야 하는지 프락시에게 말해준다.

서버는 응답에 `Vary` 헤더를 포함시켜 보냄으로써 중개자에게 내용 협상을 위해 어떤 헤더를 사용하고 있는지 알려줄 수 있다.

### 장점

웹 서버가 협상을 할 필요 없고 클라이언트 주도 협상보다 빠르다.

### 단점

투명 협상을 어떻게 구현하는지에 대한 정형화된 명세가 없다.

## 트랜스 코딩

> 서버가 클라이언트의 요구에 맞는 문서를 아예 가지고 있지 않을때, 서버는 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환하는 것을 트랜스 코딩이라고 한다.

### 포맷 변환

> 데이터를 클라이언트가 볼 수 있도록 한 포맷에서 다른 포맷으로 변환하는 것

- **내용 변환 or 트랜스코딩**: 콘텐츠를 특정 접근 장치에서 볼 수 있도록 하기 위함
- **콘텐츠 인코딩 or 전송 인코딩**: 효율적이고 안전한 콘텐츠 전송을 위함

### 정보 합성

문서에서 정보의 요점을 추출하는 것을 정보 합성이라고 한다.

### 콘텐츠 주입

> 위의 2가지 트랜스코딩은 일반적으로 웹 문서의 양을 줄이지만, 오히려 양을 늘리는 종류의 변환은 내용 주입 트랜스코딩이라는 것도 있음

페이지에 동적으로 콘텐츠(광고 or 사용자 추적 시스템) 추가

### 트랜스 코딩 vs 정적으로 미리 생성해 놓기

> 정적으로 미리 생성해 둔다면 작은 변화로 인한 수정과 저장하기 위한 많은 공간, 페이지 관리가 어려워진다.

때문에 트랜스 코딩으로 그때마다 변환시키는 것이 더 쉬운 해결책이다.
