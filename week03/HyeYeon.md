## 4장 커넥션 관리

### 4.1 TCP 커넥션

- TCP/IP: 패킷 교환 네트워크 프로토콜들의 계층화된 집합
- 클라이언트 애플리케이션이 서버 애플리케이션과 TCP/IP 커넥션을 맺으면 클라이언트와 서버 컴퓨터 간에 주고받는 메시지들은 손식 혹은 손상되거나 순서가 바뀌지 않고 안전하게 전달됨

#### 4.1.1 신뢰할 수 있는 데이터 전송 통로인 TCP

- TCP는 HTTP에게 신뢰할 만한 통신 방식을 제공하여 인터넷을 안정적으로 연결함

#### 4.1.2 TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송된다

- HTTP가 메시지를 전송하고자 할 경우, 현재 연결되어 있는 TCP 커넥션을 통해서 메시지 데이터의 내용을 순서대로 보내고, TCP는 세그먼트라는 단위로 데이터 스트림을 잘게 나누어 IP 패킷을 통해 데이터를 전달함
- IP 패킷 각각은 IP 패킷 헤더, TCP 세그먼트, TCP 데이터 조각을 포함함

#### 4.1.3 TCP 커넥션 유지하기

- TCP 커넥션은 발신지 IP주소, 발신지 포트, 수신지 IP 주소, 수신지 포트의 네 가지 값에 따라 유일한 커넥션을 생성함

### 4.2 TCP의 성능에 대한 고려

- HTTP는 TCP 바로 위에 있는 계층이기 때문에 TCP 성능에 영향을 받음

#### 4.2.1 HTTP 트랜잭션 지연

- TCP 네트워크 지연: TCP 커넥션을 설정하고, 요청 및 응답 메시지를 보내는 시간이 오래 걸림
- HTTP 트랜잭션을 지연시키는 원인의 예
  - DNS 이름 분석 인프라를 사용하여 URI에 있는 소흐트 명을 IP로 변환하는 데 걸리는 시간
  - 서버로부터 커넥션 허가 응답을 기다리는 시간
  - 요청 메시지가 서버에 의해서 처리되는 데까지 걸리는 시간
  - 웹 서버가 HTTP 응답을 보내는 시간

#### 4.2.2 성능 관련 중요 요소

- 가장 일반적인 TCP 관련 지연 요소
  - TCP 커넥션의 핸드셰이크 설정
  - TCP의 느린 시작(slow-start)
  - 네이글(nagle) 알고리즘
  - 확인응답 지연 알고리즘
  - TIME_WAIT 지연과 포트 고갈

#### 4.2.3 TCP 커넥션 핸드셰이크 지연

- 새로운 TCP 커넥션을 열 때 연속으로 IP 패킷을 교환하며 성능이 저하됨
- TCP 커넥션이 핸드셰이크를 하는 순서
  1. 클라이언트가 새로운 TCP 커넥션을 생성하기 위한 TCP 패킷을 서버로 전송(SYN)
  2. 서버가 커넥션 요청이 받아들여졌음을 의미하는 TCP 패킷을 클라이언트로 전송(SYN+ACK)
  3. 클라이언트가 커넥션이 잘 맺어짐을 알리는 확인응답 신호와 함께 데이터를 서버로 전송(SYN)
- TCP 커넥션 설정을 위한 두 개의 패킷 전송(SYN과 SYN+ACK)이 지연을 발생시킴

#### 4.2.4 확인응답 지연

- 확인응답은 그 크기가 작으므로 TCP는 같은 방향으로 송출되는 데이터 패킷에 확인응답을 편승시켜 네트워크를 효율적으로 사용함
- 확인응답 편승을 늘리기 위해 이용하는 확인응답 지연 알고리즘으로 인한 지연이 발생함

#### 4.2.5 TCP 느린 시작

- 인터넷의 급작스러운 부하와 혼잡을 방지하기 위해 처음에는 TCP 커넥션의 최대 속도(한 번에 전송할 수 있는 패킷의 수)를 제한하고 데이터가 성공적으로 전송된다면 속도 제한을 높여 나감
- 튜닝된 커넥션: 어느 정도 데이터를 주고받아 TCP 최대 속도가 높아진 커넥션

#### 4.2.6 네이글(Nagle) 알고리즘과 TCP_NODELAY

- 네이글 알고리즘
  - 네트워크 효울을 위해 패킷을 전ㄴ송하기 전에 TCP 데이터를 한 개의 덩어리로 합치는 알고리즘
  - 세그먼트가 최대 크기가 될 때까지 전송하지 않고 확인응답을 받았거나 충분한 패킷이 쌓였을 때 버퍼에 저장된 데이터를 전송
  - 확인응답 지연과 함께 쓰일 경우 성능을 크게 떨어뜨림

#### 4.2.7 TIME_WAIT의 누적과 포트 고갈

- TCP 커넥션의 종단에서 커넥션을 끊을 때 커넥션의 IP주소와 포트 번호를 기록하고, 같은 주소와 커넥션을 사용하는 새로운 TCP 커넥션이 일정 시간 동안 생성되지 않도록 방지함
- 성능 측정과 같은 상황에서 IP 주소와 포트가 제한적이므로 발생할 수 있음

### 4.3 HTTP 커넥션 관리

#### 4.3.1 흔히 잘못 이해하는 Connection 헤더

- 커넥션 토큰이 HTTP 헤더 필드 명을 가지고 있으면 Connection 헤더에 있는 모든 헤더 필드는 메시지를 다른 곳으로 전달하는 시점에 삭제되어야 함

#### 4.3.2 순차적인 트랜잭션 처리에 의한 지연

- HTTP 트랜잭션마다 새로운 커넥션을 필요로 한다면 커넥션을 맺는 데 발생하는 지연과 함께 느린 시작 지연이 발생함
- 물리적인 지연뿐 아니라 사용자가 느끼는 심리적인 지연 포함

### 4.4 병렬 커넥션

- 클라이언트가 여러 개의 커넥션을 맺음으로써 여러 개의 HTTP 트랜잭션을 병렬로 처리할 수 있게 함
